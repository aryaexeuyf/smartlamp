<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Control PJU Outdoor</title>
    <style>
        /* --- MODERN CSS --- */
        :root {
            --primary: #00e5ff;
            --dark: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --danger: #ef4444;
            --success: #22c55e;
        }
        body {
            margin: 0;
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s ease;
        }
        .logo {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
            animation: pulse 2s infinite;
        }
        .sub-logo { margin-top: 10px; letter-spacing: 2px; opacity: 0.8; }

        @keyframes pulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; transform: scale(1); } }

        /* App Container */
        #app { display: none; max-width: 600px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 15px;
        }
        .status-badge {
            padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }
        .online { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .offline { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        /* Main Switch */
        .control-panel {
            text-align: center; padding: 40px 20px;
            background: var(--surface); border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        .power-btn {
            width: 150px; height: 150px; border-radius: 50%;
            border: none; background: #334155; color: white;
            font-size: 2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 0 10px #1e293b;
            transition: all 0.3s ease; outline: none;
        }
        .power-btn.active {
            background: var(--primary);
            color: var(--dark);
            box-shadow: 0 0 30px var(--primary), 0 0 0 10px rgba(0, 229, 255, 0.2);
        }
        .power-btn:active { transform: scale(0.95); }

        /* Admin Section */
        #admin-section {
            background: var(--surface); padding: 20px; border-radius: 15px;
            display: none; margin-top: 20px;
        }
        .cam-indicator {
            padding: 10px; background: #334155; border-radius: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .cam-status { font-weight: bold; }
        .bright { color: var(--primary); }
        .dark { color: #fbbf24; } /* Kuning */
        
        button.secondary {
            background: transparent; border: 1px solid #475569; color: #94a3b8;
            padding: 8px 16px; border-radius: 8px; cursor: pointer; width: 100%;
            margin-top: 5px; transition: 0.2s;
        }
        button.secondary:hover { border-color: var(--text); color: var(--text); }

        /* Login Modal */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .login-box {
            background: var(--surface); padding: 30px; border-radius: 15px;
            width: 300px; text-align: center;
        }
        input {
            width: 100%; padding: 10px; margin: 10px 0;
            background: #0f172a; border: 1px solid #334155; color: white;
            border-radius: 5px;
        }
        .primary-btn { background: var(--primary); border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer;}

        /* Watermark */
        .watermark {
            text-align: center; font-size: 0.7rem; color: #64748b; margin-top: 30px;
        }

        /* Hidden elements */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="logo">SMART LAMP</div>
        <div class="sub-logo">Project by AryaTeam</div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <h3>Admin Access</h3>
            <p>Enter PIN</p>
            <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button class="primary-btn" onclick="checkLogin()">LOGIN</button>
            <button class="secondary" onclick="closeLogin()">Cancel</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <header>
            <div>
                <h2 style="margin:0;">Smart PJU</h2>
                <small id="wifi-status" class="status-badge offline">
                    <span id="wifi-icon">üì°</span> Connecting...
                </small>
            </div>
            <button class="secondary" style="width:auto;" onclick="openLogin()">Admin</button>
        </header>

        <main>
            <!-- User Control -->
            <div class="control-panel">
                <div class="power-btn" id="powerBtn" onclick="toggleLamp()">OFF</div>
                <p style="margin-top:15px; opacity:0.7;">Status Lampu</p>
            </div>

            <!-- Admin Section -->
            <div id="admin-section">
                <h3>Admin Dashboard</h3>
                
                <!-- Camera Feature -->
                <div class="cam-indicator">
                    <span>Light Sensor</span>
                    <span id="cam-status" class="cam-status">Detecting...</span>
                </div>
                <button class="secondary" onclick="startCamera()">Enable Auto-Light (Camera)</button>
                <p style="font-size:0.7rem; color:#aaa;">*Kamera tidak ditampilkan demi privasi. Analisis dilakukan lokal.</p>

                <hr style="border-color:#334155; margin: 20px 0;">

                <!-- Other Admin Controls -->
                <h4>Device Settings</h4>
                <button class="secondary" onclick="restartDevice()">Restart Device (Disconnect WiFi)</button>
                <button class="secondary" onclick="logout()">Logout Admin</button>
            </div>
        </main>

        <div class="watermark">Project by AryaProject</div>
    </div>

    <!-- Firebase SDK (Compat for easier usage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCfRXQKtfSQemzyESufRa-8MGNd_Pi2EeE",
            authDomain: "lampu-pju-njati.firebaseapp.com",
            databaseURL: "https://lampu-pju-njati-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lampu-pju-njati",
            storageBucket: "lampu-pju-njati.firebasestorage.app",
            messagingSenderId: "1095543830018",
            appId: "1:1095543830018:web:f6506f68944145869c591b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- STATE ---
        let lampState = false;
        let isAdmin = false;
        const ADMIN_PIN_HASH = "1984123"; // Hash sederhana atau hardcoded check untuk RCLED123

        // --- INIT ---
        window.onload = function() {
            // Loading Screen 4 detik
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    initFirebase();
                }, 1000);
            }, 4000);

            // Cek Local Storage Admin
            if(localStorage.getItem('pjuAdmin') === 'true') {
                isAdmin = true;
                document.getElementById('admin-section').style.display = 'block';
            }
        };

        // --- FIREBASE LOGIC ---
        function initFirebase() {
            const ref = db.ref('/PJU/lampState');
            
            // Mendengarkan perubahan dari ESP
            ref.on('value', (snapshot) => {
                const val = snapshot.val();
                if (val !== null) {
                    lampState = val;
                    updateUI();
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            }, (error) => {
                console.error("Firebase Error:", error);
                updateConnectionStatus(false);
            });
        }

        function toggleLamp() {
            lampState = !lampState;
            sendToFirebase();
        }

        function sendToFirebase() {
            db.ref('/PJU/lampState').set(lampState);
            updateUI();
        }

        function updateUI() {
            const btn = document.getElementById('powerBtn');
            if(lampState) {
                btn.innerText = "ON";
                btn.classList.add('active');
            } else {
                btn.innerText = "OFF";
                btn.classList.remove('active');
            }
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('wifi-status');
            if(connected) {
                badge.className = 'status-badge online';
                badge.innerHTML = '<span id="wifi-icon">üì∂</span> Device Online';
            } else {
                badge.className = 'status-badge offline';
                badge.innerHTML = '<span id="wifi-icon">‚ö†Ô∏è</span> Device Offline';
            }
        }

        // --- ADMIN LOGIC ---
        function openLogin() {
            if(isAdmin) return; // Sudah login
            document.getElementById('login-modal').style.display = 'flex';
        }
        function closeLogin() {
            document.getElementById('login-modal').style.display = 'none';
        }
        function checkLogin() {
            const pin = document.getElementById('pinInput').value;
            // PIN: RCLED123 (Sembunyikan logika di sini)
            if(pin === "RCLED123") {
                isAdmin = true;
                localStorage.setItem('pjuAdmin', 'true');
                document.getElementById('admin-section').style.display = 'block';
                closeLogin();
            } else {
                alert("PIN Salah!");
            }
        }
        function logout() {
            isAdmin = false;
            localStorage.removeItem('pjuAdmin');
            document.getElementById('admin-section').style.display = 'none';
        }

        function restartDevice() {
            if(confirm("Restart perangkat ESP? Koneksi akan terputus.")) {
                // Memicu flag restart di Firebase
                db.ref('/PJU/command').set("restart");
                alert("Perintah restart dikirim.");
            }
        }

        // --- KAMERA & LIGHT SENSOR ---
        let video, canvas, ctx;
        let isCamRunning = false;

        async function startCamera() {
            if(isCamRunning) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                
                // Buat elemen video tersembunyi
                video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                canvas = document.createElement('canvas');
                ctx = canvas.getContext('2d');
                
                isCamRunning = true;
                detectBrightness();
                alert("Kamera aktif. Mendeteksi cahaya...");
            } catch (err) {
                console.error(err);
                alert("Gagal akses kamera. Pastikan izinkan akses kamera.");
            }
        }

        function detectBrightness() {
            if(!isCamRunning) return;

            // Gambar frame ke canvas
            canvas.width = 100; // Kecilkan resolusi agar performa tinggi
            canvas.height = 75;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Ambil data piksel
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let r, g, b, avg;
            let colorSum = 0;

            // Loop piksel
            for(let x = 0, len = data.length; x < len; x+=4) {
                r = data[x];
                g = data[x+1];
                b = data[x+2];
                avg = Math.floor((r+g+b)/3);
                colorSum += avg;
            }

            const brightness = Math.floor(colorSum / (canvas.width * canvas.height));
            const statusEl = document.getElementById('cam-status');

            // Logika Threshold (misal < 100 gelap)
            if(brightness < 100) {
                statusEl.innerText = "Gelap (Auto ON)";
                statusEl.className = "cam-status dark";
                // Kirim perintah ON hanya jika berbeda (optional debouncing)
                db.ref('/PJU/lampState').set(true); 
            } else {
                statusEl.innerText = "Terang (Auto OFF)";
                statusEl.className = "cam-status bright";
                db.ref('/PJU/lampState').set(false);
            }

            // Ulangi deteksi setiap 1 detik
            setTimeout(detectBrightness, 1000);
        }

    </script>
</body>
</html>
